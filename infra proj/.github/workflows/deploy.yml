name: Deploy to Azure (Demo)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - uses: actions/checkout@v3
    
    # TODO: Configure Azure Service Principal before deploying
    # Create service principal: az ad sp create-for-rbac --name "ai-ecom-deploy" --role contributor --scopes /subscriptions/{subscription-id}
    
    # - name: Azure Login
    #   uses: azure/login@v1
    #   with:
    #     creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
    
    # - name: Terraform Init
    #   working-directory: ./infra/terraform
    #   run: |
    #     terraform init \
    #       -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
    #       -backend-config="container_name=tfstate" \
    #       -backend-config="key=${{ github.event.inputs.environment }}.tfstate"
    
    # - name: Terraform Apply
    #   working-directory: ./infra/terraform
    #   run: terraform apply -var-file="${{ github.event.inputs.environment }}.tfvars" -auto-approve
    #   env:
    #     ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
    #     ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
    #     ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
    #     ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

  deploy-backend:
    runs-on: ubuntu-latest
    # needs: deploy-infrastructure
    
    steps:
    - uses: actions/checkout@v3
    
    # - name: Azure Login
    #   uses: azure/login@v1
    #   with:
    #     creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build Backend Docker Image
      working-directory: ./backend
      run: |
        echo "Building Docker image..."
        # docker build -t ai-ecom-backend:${{ github.sha }} .
    
    # - name: Push to Azure Container Registry
    #   run: |
    #     az acr login --name ${{ secrets.ACR_NAME }}
    #     docker tag ai-ecom-backend:${{ github.sha }} ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
    #     docker push ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}
    
    # - name: Deploy to App Service
    #   run: |
    #     az webapp config container set \
    #       --name app-ai-ecom-${{ github.event.inputs.environment }}-api \
    #       --resource-group rg-ai-ecom-${{ github.event.inputs.environment }}-eastus \
    #       --docker-custom-image-name ${{ secrets.ACR_NAME }}.azurecr.io/backend:${{ github.sha }}

  deploy-frontend:
    runs-on: ubuntu-latest
    # needs: deploy-infrastructure
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Build Frontend
      working-directory: ./frontend
      run: |
        npm ci
        npm run build
    
    # - name: Deploy to Azure Static Web Apps
    #   uses: Azure/static-web-apps-deploy@v1
    #   with:
    #     azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
    #     repo_token: ${{ secrets.GITHUB_TOKEN }}
    #     action: "upload"
    #     app_location: "/frontend"
    #     output_location: "dist"
